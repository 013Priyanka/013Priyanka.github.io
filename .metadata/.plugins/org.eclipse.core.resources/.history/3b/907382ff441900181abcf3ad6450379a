package com.dtproject.model;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.webflow.execution.RequestContext;

import com.dtproject.service.CartItemService;
import com.dtproject.service.ProductService;
import com.dtproject.service.ShippingService;
import com.dtproject.service.UserService;


@Component
public class FlowHandler 
{
	@Autowired
	private UserService userService;
	
	@Autowired
	private User user; 
	
	@Autowired
	private ProductService productService;
	
	@Autowired
	private CartItemService cartItemService;
	
	@Autowired
	private ShippingService shippingService;
	
	private List<ShippingAddress> addressList;
	
	public void initOrders(Orders orders)
	{
		System.out.println("init orders");
		String userName=SecurityContextHolder.getContext().getAuthentication().getName();
		user=userService.findUserByName(userName);
		
		
	}
	public Orders addTocart(int pId,int pQuantity,Orders order)
	{
		Product product=productService.findProductById(pId);
		List<CartItem> cartItem=cartItemService.findByCartId(user.getCartId());
		CartItem cart=null;
		int i=0;
		if(!cartItem.isEmpty())
		{
			for(CartItem citem:cartItem)
			{
				if(citem.getProductId()==pId)//if there is same product already in the cart which user want to buy;
				{
					cart.setQuantity(citem.getQuantity()+pQuantity);
					cart.setCartId(citem.getCartId());
					cart.setProductId(citem.getProductId());
					cart.setCartItem_id(citem.getCartItem_id());
					cart.setProductprice(cart.getQuantity()*product.getpPrice());
//					cart.setBillingAddress(citem.getBillingAddress());
//					cart.setShippingAddress(citem.getShippingAddress());
				i=1;
				}
				
			}
		}
		if(i==0)
		{
			cart.setProductId(product.getpId());
			cart.setCartId(user.getCartId());
			cart.setProductprice(product.getpPrice());
			cart.setQuantity(product.getpQuantity());
			
			
		}
		order.setCartItem(cart);
		
		return order;
		
	}
	 public String checkShippingAddress()
	 {
		 List<ShippingAddress> shippingAddress=shippingService.getAddressByUserName(user.getuName());
        if(shippingAddress.isEmpty())
        {
        	System.out.println("address list is empty");
        	return "empty";
        }
        else
        {
        	addressList=shippingAddress;
        	return "available";
        }
		 
	 }
	 
	 public Orders attachAddress(Orders orders,RequestContext context)
	 {
		 String s=context.getRequestParameters().get("billingAddress");
		 if(!s.equals(null))
		 {
			 ShippingAddress shippingAddress=orders.getsAddress();
			 BillingAddress billingAddress=new BillingAddress();
			 billingAddress.setAddress(shippingAddress.getAddress());
			 billingAddress.setCity(shippingAddress.getCity());
			 billingAddress.setPincode(shippingAddress.getPincode());
			 billingAddress.setState(shippingAddress.getState());
			 billingAddress.setUsername(shippingAddress.getUsername());
			 orders.setbAddress(billingAddress);
		 }
		return orders;
		 
	 }
	 public Orders getAddress(Orders orders)
	 {
		 orders.setShippingAddressList(addressList);;
		return orders;
		 
	 }
	 public Orders sAddress(Orders order)
	 {
		 int sId=order.getsAddress().getShippingId();
		 ShippingAddress shippingAddress=shippingService.findAddressByShippingId(sId);
		order.setsAddress(shippingAddress);
		 return order;
		 
	 }
}
